# Default Process Workflows
#
# These workflows are loaded into the database on first startup.
# They can be edited, duplicated, or disabled through the UI.
# Default workflows cannot be deleted.

workflows:
  # Naming Convention Validation
  - id: "naming-convention-check"
    name: "Naming Convention Validation"
    description: "Validates that catalog objects follow naming conventions (lowercase with underscores). Applies auto-fix for required tags when possible."
    trigger:
      type: "on_create"
      entity_types:
        - "catalog"
        - "schema"
        - "table"
    scope:
      type: "all"
    is_active: true
    is_default: true
    steps:
      - id: "validate-name"
        name: "Validate Naming Convention"
        type: "validation"
        config:
          rule: |
            MATCH (obj:Object)
            ASSERT obj.name MATCHES '^[a-z][a-z0-9_]*$'
            ON_FAIL FAIL 'Name must be lowercase with underscores only (e.g., my_table_name)'
        on_pass: "check-owner-tag"
        on_fail: "notify-naming-failure"

      - id: "check-owner-tag"
        name: "Check Owner Tag"
        type: "validation"
        config:
          rule: |
            MATCH (obj:Object)
            ASSERT HAS_TAG('owner')
            ON_FAIL FAIL 'Owner tag is required'
        on_pass: "success"
        on_fail: "auto-fix-owner-tag"

      - id: "auto-fix-owner-tag"
        name: "Auto-assign Owner Tag"
        type: "assign_tag"
        config:
          key: "owner"
          value_source: "current_user"
        on_pass: "success"
        on_fail: "notify-tag-failure"

      - id: "notify-naming-failure"
        name: "Notify Naming Failure"
        type: "notification"
        config:
          recipients: "requester"
          template: "validation_failed"
          custom_message: "The object name does not follow naming conventions. Names must be lowercase with underscores only."
        on_pass: "fail-naming"

      - id: "notify-tag-failure"
        name: "Notify Tag Failure"
        type: "notification"
        config:
          recipients: "requester"
          template: "validation_failed"
          custom_message: "Could not auto-assign owner tag. Please add the owner tag manually."
        on_pass: "fail-tagging"

      - id: "success"
        name: "Validation Passed"
        type: "pass"

      - id: "fail-naming"
        name: "Naming Convention Failed"
        type: "fail"
        config:
          message: "Object name does not follow naming conventions"

      - id: "fail-tagging"
        name: "Tagging Failed"
        type: "fail"
        config:
          message: "Required tags could not be applied"

  # Data Product Publish Approval
  - id: "data-product-approval"
    name: "Data Product Publish Approval"
    description: "Requires domain owner approval before publishing data products from draft to published status."
    trigger:
      type: "on_status_change"
      entity_types:
        - "data_product"
      from_status: "draft"
      to_status: "published"
    scope:
      type: "all"
    is_active: true
    is_default: true
    steps:
      - id: "check-contract"
        name: "Check Data Contract"
        type: "validation"
        config:
          rule: |
            MATCH (obj:Object)
            ASSERT obj.contract_id != '' OR obj.contracts != []
            ON_FAIL FAIL 'Data product must have at least one data contract'
        on_pass: "request-approval"
        on_fail: "notify-no-contract"

      - id: "request-approval"
        name: "Request Domain Owner Approval"
        type: "approval"
        config:
          approvers: "domain_owners"
          timeout_days: 7
          require_all: false
        on_pass: "notify-approved"
        on_fail: "notify-rejected"

      - id: "notify-no-contract"
        name: "Notify Missing Contract"
        type: "notification"
        config:
          recipients: "requester"
          template: "validation_failed"
          custom_message: "Cannot publish data product without a data contract. Please attach at least one contract first."
        on_pass: "fail-no-contract"

      - id: "notify-approved"
        name: "Notify Approval"
        type: "notification"
        config:
          recipients: "requester"
          template: "product_approved"
          custom_message: "Your data product has been approved and is now published."
        on_pass: "success"

      - id: "notify-rejected"
        name: "Notify Rejection"
        type: "notification"
        config:
          recipients: "requester"
          template: "product_rejected"
          custom_message: "Your data product publish request has been rejected. Please review the feedback and resubmit."
        on_pass: "fail-rejected"

      - id: "success"
        name: "Publish Approved"
        type: "pass"

      - id: "fail-no-contract"
        name: "No Contract"
        type: "fail"
        config:
          message: "Data product requires a data contract"

      - id: "fail-rejected"
        name: "Publish Rejected"
        type: "fail"
        config:
          message: "Data product publish request was rejected"

  # Data Contract Validation
  - id: "data-contract-validation"
    name: "Data Contract Schema Validation"
    description: "Validates that data contracts have required schema fields and quality rules defined."
    trigger:
      type: "on_create"
      entity_types:
        - "data_contract"
    scope:
      type: "all"
    is_active: true
    is_default: true
    steps:
      - id: "check-schema"
        name: "Check Schema Definition"
        type: "validation"
        config:
          rule: |
            MATCH (obj:Object)
            ASSERT obj.schema != '' AND obj.schema != '{}' AND obj.schema != '[]'
            ON_FAIL FAIL 'Data contract must have a schema defined'
        on_pass: "check-owner"
        on_fail: "notify-no-schema"

      - id: "check-owner"
        name: "Check Owner"
        type: "validation"
        config:
          rule: |
            MATCH (obj:Object)
            ASSERT obj.owner != '' OR HAS_TAG('owner')
            ON_FAIL FAIL 'Data contract must have an owner'
        on_pass: "success"
        on_fail: "auto-fix-owner"

      - id: "auto-fix-owner"
        name: "Auto-assign Owner"
        type: "assign_tag"
        config:
          key: "owner"
          value_source: "current_user"
        on_pass: "success"

      - id: "notify-no-schema"
        name: "Notify Missing Schema"
        type: "notification"
        config:
          recipients: "requester"
          template: "validation_failed"
          custom_message: "Data contract must have a schema definition. Please add the schema before proceeding."
        on_pass: "fail-no-schema"

      - id: "success"
        name: "Validation Passed"
        type: "pass"

      - id: "fail-no-schema"
        name: "No Schema"
        type: "fail"
        config:
          message: "Data contract requires a schema definition"

  # PII Detection and Tagging
  - id: "pii-detection"
    name: "PII Detection and Classification"
    description: "Detects potential PII columns and applies appropriate tags for data governance."
    trigger:
      type: "on_create"
      entity_types:
        - "table"
    scope:
      type: "all"
    is_active: false  # Disabled by default - enable when needed
    is_default: true
    steps:
      - id: "check-pii-columns"
        name: "Check for PII Columns"
        type: "conditional"
        config:
          condition: |
            obj.name CONTAINS 'email' OR obj.name CONTAINS 'phone' OR 
            obj.name CONTAINS 'ssn' OR obj.name CONTAINS 'address' OR
            obj.name CONTAINS 'dob' OR obj.name CONTAINS 'birth'
        on_pass: "tag-pii"
        on_fail: "success-no-pii"

      - id: "tag-pii"
        name: "Apply PII Tag"
        type: "assign_tag"
        config:
          key: "contains_pii"
          value: "true"
        on_pass: "notify-pii-detected"

      - id: "notify-pii-detected"
        name: "Notify PII Detection"
        type: "notification"
        config:
          recipients: "requester"
          template: "pii_detected"
          custom_message: "Potential PII detected in table. The table has been tagged for review."
        on_pass: "success-pii"

      - id: "success-no-pii"
        name: "No PII Detected"
        type: "pass"

      - id: "success-pii"
        name: "PII Tagged"
        type: "pass"

  # Dataset Subscription Notification
  - id: "dataset-subscription-notify"
    name: "Dataset Update Notification"
    description: "Notifies subscribers when a dataset is updated."
    trigger:
      type: "on_update"
      entity_types:
        - "dataset"
    scope:
      type: "all"
    is_active: true
    is_default: true
    steps:
      - id: "check-subscribers"
        name: "Check for Subscribers"
        type: "conditional"
        config:
          condition: |
            LENGTH(obj.subscribers) > 0 OR LENGTH(obj.subscriptions) > 0
        on_pass: "notify-subscribers"
        on_fail: "success-no-subscribers"

      - id: "notify-subscribers"
        name: "Notify Subscribers"
        type: "notification"
        config:
          recipients: "owner"  # Will be enhanced to support subscriber list
          template: "dataset_updated"
          custom_message: "A dataset you are subscribed to has been updated."
        on_pass: "success"

      - id: "success-no-subscribers"
        name: "No Subscribers"
        type: "pass"

      - id: "success"
        name: "Subscribers Notified"
        type: "pass"

  # Pre-Creation Compliance Check (Inline Validation)
  - id: "pre-creation-compliance"
    name: "Pre-Creation Compliance Validation"
    description: "Runs compliance policy checks BEFORE creating assets. Blocks creation if policies fail. Uses policy_check steps to reference existing compliance policies by ID."
    trigger:
      type: "before_create"
      entity_types:
        - "catalog"
        - "schema"
        - "table"
    scope:
      type: "all"
    is_active: false  # Disabled by default - enable after configuring policies
    is_default: true
    steps:
      - id: "naming-policy-check"
        name: "Check Naming Convention Policy"
        type: "policy_check"
        config:
          # This policy_id should be replaced with an actual UUID from your compliance policies
          # The UI allows selecting policies from a dropdown
          policy_id: "naming-conventions"
          policy_name: "Naming Conventions"
        on_pass: "tagging-policy-check"
        on_fail: "fail-naming"

      - id: "tagging-policy-check"
        name: "Check Required Tags Policy"
        type: "policy_check"
        config:
          policy_id: "required-tags"
          policy_name: "Required Tags"
        on_pass: "success"
        on_fail: "fail-tagging"

      - id: "success"
        name: "All Policies Passed"
        type: "pass"

      - id: "fail-naming"
        name: "Naming Policy Failed"
        type: "fail"
        config:
          message: "Asset name does not comply with naming convention policy"

      - id: "fail-tagging"
        name: "Tagging Policy Failed"
        type: "fail"
        config:
          message: "Asset does not have required tags"

  # Pre-Creation Table Validation
  - id: "table-pre-creation"
    name: "Table Pre-Creation Validation"
    description: "Validates table definitions before creation, including naming conventions and schema requirements."
    trigger:
      type: "before_create"
      entity_types:
        - "table"
    scope:
      type: "all"
    is_active: true
    is_default: true
    steps:
      - id: "validate-table-name"
        name: "Validate Table Name"
        type: "validation"
        config:
          rule: |
            MATCH (obj:Object)
            ASSERT obj.name MATCHES '^[a-z][a-z0-9_]*$'
            ON_FAIL FAIL 'Table name must be lowercase with underscores only (e.g., my_table)'
        on_pass: "validate-no-reserved-words"
        on_fail: "fail-invalid-name"

      - id: "validate-no-reserved-words"
        name: "Check Reserved Words"
        type: "validation"
        config:
          rule: |
            MATCH (obj:Object)
            ASSERT NOT (obj.name = 'table' OR obj.name = 'select' OR obj.name = 'insert' OR obj.name = 'update' OR obj.name = 'delete' OR obj.name = 'from' OR obj.name = 'where')
            ON_FAIL FAIL 'Table name cannot be a SQL reserved word'
        on_pass: "success"
        on_fail: "fail-reserved-word"

      - id: "success"
        name: "Table Validation Passed"
        type: "pass"

      - id: "fail-invalid-name"
        name: "Invalid Table Name"
        type: "fail"
        config:
          message: "Table name must be lowercase with underscores only"

      - id: "fail-reserved-word"
        name: "Reserved Word Used"
        type: "fail"
        config:
          message: "Table name cannot be a SQL reserved word"

